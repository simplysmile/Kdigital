$.fn.dsave=function(l){((l=$.extend({text:{root:"최상위",parent:"상위",children:"하위",saved:"저장 되었습니다.",removeConfirm:"정말 제거하시겠습니까?",initConfirm:"정말 초기화를 하시겠습니까?"},prepend:!0,has_children:!1,parents:[],sortable:!0,movable:!1,complete:function(e){},depth:0,module:"slides",uid_parent:0,order_by:"seq",order_dir:"asc",skin:"",default_target:"_self",fields:[],baseurl:""},l)).has_children||1<l.depth)&&l.fields.push({draw:function(e,t,a){$("<a />").attr("href",a.baseurl+"/"+t.uid).addClass("btn waves-effect btn-block has-children").html('<span class="fa fa-edit"></span> '+a.text.children+' <span class="n teal-text">'+t.n_children+"</span>").appendTo(e)}});var d=this.addClass("dsave");"true"!=d.attr("data-dsave-single")&&l.fields.push({key:"active",isaction:!0,draw:function(e,t){var a=$("<div />").addClass("switch").appendTo(t),d=$("<label />").appendTo(a);d.append("OFF");$("<input />").attr({type:"checkbox"}).appendTo(d).prop("checked","Y"==e),$("<span />").addClass("lever").appendTo(d);d.append("ON")}}),0==$("#dsave-file-image").length&&$("body").append('\t\t\t<div id="dsave-file-image" class="blueimp-gallery simple">\t\t\t\t<div class="slides"></div>\t\t\t\t<h3 class="title"></h3>\t\t\t\t<a class="prev" style="display: block;"><span class="fa fa-fw fa-chevron-left"></span></a>\t\t\t\t<a class="next" style="display: block;"><span class="fa fa-fw fa-chevron-right"></span></a>\t\t\t\t<a class="close" style="display: block;"><span class="fa fa-fw fa-times"></span></a>\t\t\t\t\x3c!--a class="play-pause" style="display: block;"></a--\x3e\t\t\t\t<ol class="indicator" style="display: block;"></ol>\t\t\t</div>\t\t');var a=$("<div />").addClass("dsave-buttons-wrap").appendTo(d),s=$("<div />").addClass("dsave-add-button-wrap").appendTo(a),p=$("<div />").addClass("dsave-items row").appendTo(d),i=$("<div />").addClass("dsave-loading").spin({color:"#fff",length:6,radius:8,width:3}).hide().appendTo(s),t=$("<div />").addClass("dsave-loading").spin({length:9,radius:11,width:4}).appendTo(p);if("seq"!=l.order_by&&(l.sortable=!1),l.sortable&&(p.sortable({handle:".card",items:"> .dsave-item",stop:function(e,t){"object"==typeof t&&"object"==typeof t.item&&t.item[0]&&$(t.item[0]).find(".cke").prev("textarea").reinstallEditor()},update:function(){p.trigger("dsave-update-order")}}).bind("dsave-update-order",function(){var e=$(this).sortable("serialize");$.dpost(l.baseurl+"/order",e,function(e){"__OK__"==e?$.dtoast(l.text.saved):$.dtoast(e)},"text")}),l.movable)){var n=null,r=null,o=null,c=null;p.on("sortstart",function(e,t){n=a.find(".dsave-parent"),o=p.find(p.sortable("option","items")).not(t.item).not(t.placeholder)}).on("sortbeforestop",function(e,a){var t=a.item.attr("data-uid");n.removeClass("dsave-parent-hover"),r&&$.dpost(l.baseurl+"/update",{uid:t,key:"uid_parent",val:r.attr("data-uid")},function(e){"__OK__"==e?$.dpost(l.baseurl+"/update",{uid:t,key:"seq",val:"0"},function(e){"__OK__"==e?a.item.remove():$.dtoast(e)},"text"):$.dtoast(e)},"text"),o.find(".card").removeClass("active"),c&&$.dpost(l.baseurl+"/update",{uid:t,key:"uid_parent",val:c.attr("data-uid")},function(e){"__OK__"==e?$.dpost(l.baseurl+"/update",{uid:t,key:"seq",val:"0"},function(e){if("__OK__"==e){a.item.remove();var t=c.find(".has-children .n");t.text(parseInt(t.text())+1)}else $.dtoast(e)},"text"):$.dtoast(e)},"text")}).on("sort",function(s,e){r=null,n.each(function(){var e=$(this),t=e.offset(),a=e.outerWidth(),d=e.outerHeight();e.attr("href")&&s.pageX>t.left&&s.pageX<t.left+a&&s.pageY>t.top&&s.pageY<t.top+d?(r=e).addClass("dsave-parent-hover"):e.removeClass("dsave-parent-hover")}),c=null,o.each(function(){var e=$(this),t=e.offset(),a=e.outerWidth(),d=e.outerHeight();s.pageX>t.left&&s.pageX<t.left+a&&s.pageY>t.top&&s.pageY<t.top+d&&0<e.find("a.has-children").length?(c=e).find(".card").addClass("active"):e.find(".card").removeClass("active")}),e.item.css("opacity",r||c?".5":"1")})}function f(s,e){var t=$("<div />").addClass("dsave-item col s12 m4").attr("data-uid",s.uid).attr("id","item-"+s.uid);e?t.prependTo(p):t.appendTo(p);var i=$("<div />").addClass("card").appendTo(t),n=$("<div />").addClass("card-content").appendTo(i),r=$("<div />").addClass("card-action");"true"!=d.attr("data-dsave-single")?r.appendTo(i):n.addClass("card-content-no-action");var o='input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="tel"], input[type="number"], input[type="search"], select, textarea';$(l.fields).each(function(){var a=this;if(a.key){var d=$("<form />").attr("action",l.baseurl+"/update").attr("method","post").addClass("dsave-form-"+a.key).submit(function(){return!1}).appendTo(a.isaction?r:n),e=$("<div />").addClass("dsave-field").addClass("dsave-field-"+a.key).appendTo(d);1==a.isextra&&("string"!=typeof s.extra||s.extra.match(/^{.*}$/)||(s.extra={}),"object"==typeof s.extra&&s.extra||(s.extra=$.parseJSON(s.extra),null==s.extra&&(s.extra={})),void 0===s.extra[a.key]&&(s.extra[a.key]=""));var t=a.isextra?s.extra[a.key]:s[a.key];a.draw(t,e,s,l),0<e.find(o).length&&e.addClass("input-field"),t&&e.find("label").addClass("active"),e.find(o+', input[type="checkbox"], input[type="radio"]').bind("dsave-update-data",function(){var e=$(this),t=e.val();e.hasClass("dform-error")||("checkbox"==e.attr("type")&&(t=e.prop("checked")?"Y":"N"),$.dpost(d.attr("action"),{uid:s.uid,key:a.key,isextra:1==a.isextra?"true":"false",val:t},function(e){"__OK__"==e?0==$("#toast-container").children().length&&$.dtoast(l.text.saved):$.dtoast(e)},"text"))}).change(function(){$(this).trigger("dsave-update-data")})}else a.draw(i,s,l)}),$('<button type="button" />').html('<span class="fa fa-fw fa-times"></span>').addClass("dsave-remove btn btn-floating waves-effect waves-light").focus(function(){$(this).blur()}).appendTo(i).click(function(e){e.preventDefault(),$.dconfirm(l.text.removeConfirm,function(){$.dpost(l.baseurl+"/remove",{uid:s.uid},function(e){t.remove(),$.dtoast(l.text.saved)},"text")})}),$("<div />").addClass("clearfix").appendTo(n)}if(0<l.uid_parent&&"false"!=d.attr("data-dsave-view-parent")){var e=$("<nav />").addClass("dsave-breadcrumb-wrap").prependTo(a);e.tooltip({position:"left middle",content:l.text.parent});for(var u=$("<div />").addClass("nav-wrapper black").appendTo(e),v=l.parents,h=l.baseurl.split("/"),m=0;m<v.length;m++)h.pop();h=h.join("/"),$("<a />").addClass("dsave-parent breadcrumb").attr("href",h).text(l.text.root).appendTo(u);for(m=0;m<v.length;m++){var b=v[m];h+="/"+b.uid,m==v.length-1?$("<span />").addClass("dsave-parent breadcrumb").text(b.title?b.title:l.text.parent).appendTo(u):$("<a />").addClass("dsave-parent breadcrumb").attr("href",h).attr("data-uid",b.uid).attr("data-uid-parent",b.uid_parent).text(b.title?b.title:l.text.parent).appendTo(u)}}var g=$('<button type="button" />').addClass("dsave-add").addClass("btn-floating btn-large waves-effect waves-light red");return g.append('<i class="material-icons">add</i>').appendTo(s).click(function(e){if(e.preventDefault(),d.attr("data-dsave-multifile")){var t=d.attr("data-dsave-multifile"),a="dsave-multifile-"+t;$("#"+a).remove(),$('<input type="file" name="file[]" />').attr({id:a,type:"file",name:"file[]"}).prop("multiple",!0).addClass("dsave-multifile").appendTo(s).change(function(){g.prop("disabled",!0),i.show(),g.find("i").hide(),$.ajaxFileUpload({url:l.baseurl+"/uploads",fileElementId:a,dataType:"json",data:{module:t},success:function(e,t){i.hide(),g.find("i").show(),g.prop("disabled",!1),void 0===e.error||""==e.error?void 0!==e.rows&&e.rows&&($(e.rows).each(function(){f(this,l.prepend)}),p.trigger("dsave-update-order")):$.dalert(e.error)},error:function(e){i.hide(),g.find("i").show(),g.prop("disabled",!1),$.dalert(e)}})}).click()}else g.prop("disabled",!0),i.show(),g.find("i").hide(),$.dpost(l.baseurl+"/add",function(e){i.hide(),g.find("i").show(),g.prop("disabled",!1),f(e,l.prepend),p.trigger("dsave-update-order"),p.find(".dsave-item:"+(l.prepend?"first":"last")).find("select").each(function(){$(this).find("option:first").prop("selected",!0).end().trigger("dsave-update-data")})},"json")}),"true"==d.attr("data-dsave-single")&&g.hide(),$.dpost(l.baseurl+"/get-all",function(e){t.remove(),$(e).each(function(){f(this)}),l.complete(e),"true"==d.attr("data-dsave-single")&&0==$(e).length&&setTimeout(function(){g.click()},1)},"json"),this},$.dsaveFile=function(d,s,t,i,e,a){a=$.extend(!0,{path:"",valign:"",halign:"",voffset:0,hoffset:0},a),s.files;t.addClass("dsave-file");var n="dsave-inputfile-"+d+"-"+s.uid,r=$("<div />").addClass("dsave-loading").spin({length:4,radius:6,width:2}).hide().appendTo(t),o=$("<div />").addClass("dsave-file-thumb").appendTo(t),l=$('<button type="button" />').html('<span class="fa fa-upload"></span>').addClass("dsave-file-btn-upload teal waves-effect white-text z-depth-1").appendTo(t);function p(){o.empty().addClass("dsave-file-thumb-no-image").html('<span class="middle-outer"><span class="middle-inner"><span class="fa fa-photo"></span></span></span>')}function c(e,t){p();var a=e[d];if("object"==typeof e[d]){if(t.empty(),a.is_image)$("<a />").attr("href",a.url).addClass("dsave-file-image").attr("data-gallery","#dsave-file-image").tooltip({position:"top center",content:a.fname}).css({backgroundImage:"url("+a.thumbnail+")"}).appendTo(t.removeClass("dsave-file-thumb-no-image"));else $("<a />").attr("href",a.url).prop("download",a.fname).addClass("dsave-file-download no-pjax").html('<span class="middle-outer"><span class="middle-inner"><span class="fa fa-file-o"></span></span></span>').tooltip({position:"top center",content:a.fname}).appendTo(t);$('<button type="button" />').html('<span class="fa fa-fw fa-times"></span>').addClass("dsave-remove btn btn-floating waves-effect waves-light").appendTo(t).click(function(e){e.preventDefault(),$.dconfirm(i.text.removeConfirm,function(){$.dpost(i.baseurl+"/deletefile",{uid:s.uid,module:d},function(e){"__OK__"==e?p():$.dtoast(e)},"text")})})}}e&&l.tooltip({position:"top center",content:e}),l.click(function(e){e.preventDefault(),t.find('input[type="file"]').remove(),$('<input type="file" name="file" />').attr("id",n).addClass("dsave-file-input").appendTo(t).click()}),$(document).on("change","input#"+n,function(){r.show(),$.ajaxFileUpload({url:i.baseurl+"/upload",fileElementId:n,dataType:"json",data:{uid:s.uid,module:d,watermark_path:a.path,watermark_valign:a.valign,watermark_halign:a.halign,watermark_voffset:a.voffset,watermark_hoffset:a.hoffset},success:function(e,t){r.hide(),void 0===e.error||""==e.error?c(e.files,o):$.dalert(e.error)},error:function(e){r.hide(),$.dalert(e)}})}),c(s.files,o)},$.fn.dsaveSelectOption=function(a,d,s){return this.each(function(){var e=$(this);e.prop("multiple")&&null!=a&&(a=a.split(","));var t=$("<option />").attr("value",d).text(s).appendTo(e);""==d&&t.prop("disabled",!0),"object"==typeof a&&null!=a?a.forEach(function(e){e==d&&t.prop("selected",!0)}):a==d&&t.prop("selected",!0)})},$.fn.dsaveSelect=function(){return this.each(function(){var e=$(this);e.material_select(function(){e.siblings("input.select-dropdown").trigger("close")})})},$.dsaveSelect=function(e,t,a,d){var s=$("<select />");return 1==d&&s.prop("multiple",!0),$(a).each(function(){s.dsaveSelectOption(e,this[0],this[1])}),s.appendTo(t).dsaveSelect()},$.dsaveText=function(e,t,a,d){var s=$('<input type="text" />').appendTo(t).val(e).dform($.extend(!0,{required:{is:!1}},d));return $("<label />").addClass("active").text(a).appendTo(t),s},$.dsaveColor=function(e,t,a,d){$.dsaveText(e,t,a,d).blur(function(){$(this).trigger("dsave-update-data")}).installColorPicker()},$.dsaveDate=function(e,t,a,d){var s=$.dsaveText(e,t,a,d);return s.datepicker($.extend(!0,$.datepicker_ko,{yearRange:"1970:"+(parseInt(moment().format("Y"))+10),changeYear:!0})),s},$.dsaveDateTime=function(e,t,a,d){var s=$.dsaveText(e,t,a,d);return s.datetimepicker($.extend(!0,$.datepicker_ko,{yearRange:"1970:"+(parseInt(moment().format("Y"))+10),changeYear:!0})),s},$.dsaveTextArea=function(e,t,a,d){var s=$('<textarea cols="80" rows="3" />').addClass("materialize-textarea").appendTo(t).val(e).dform($.extend(!0,{required:{is:!1}},d));return $("<label />").text(a).appendTo(t),s},$.dsaveTextEditor=function(e,t,a,d,s){return $('<textarea cols="80" rows="3" />').addClass("materialize-textarea").appendTo(t).val(e).attr({id:"editor-"+(Math.random()+"").replace(/^0\./,""),"data-editor-height":"100px","data-editor-tool":s||"minimum"}).dform($.extend(!0,{required:{is:!1}},d)).installCkeditor()},$(document).bind("dofirst",function(e,t){$(t).find('.dsave-single[contenteditable="true"]:not(.cke_editable)').each(function(){var a=$(this),d=a.data("dsave-single-module"),s=a.data("dsave-single-uid"),i=a.html(),n=a.hasClass("dsave-single-richtext");if(a.prop("spellcheck",!1),n){var e=$.ckeditorOpt($.extend(!0,$.ckeditorOptTemplate("full"),{allowedContent:!0,filebrowserUploadUrl:"/api/dsavesingleupload/file/"+d+(s?"/"+s:""),filebrowserImageUploadUrl:"/api/dsavesingleupload/img/"+d+(s?"/"+s:"")}));a.attr("data-editor-templates")&&(e.templates=$(this).attr("data-editor-templates")),a.ckeditor(e)}a.bind("blur",function(){var e=a.data("ckeditorInstance"),t=n&&e?e.getData():a.html();i!=t&&(n||(t=(t=(t=(t=(t=t.replace(/\<br[\ ]*[\/]{0,1}\>/gi,"\n")).replace(/\>[ \t\n]+\</g,"><")).replace(/\<\/[^\>]+\>\<[^\/\>]+\>/g,"\n")).replace(/\<[^\>]+\>/g,"")).replace(/\n/g,"<br />"),a.html(t)),$.dpost("/api/dsavesingle",{module:d,uid:s,extra:t},function(e){"__OK__"==e?$.dtoast("저장 되었습니다."):$.dtoast(e)},"text"))})})});
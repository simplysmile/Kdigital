/* dpost
 * --------------------------------------------------------------------- */
$.each(['dget', 'dpost'], function (_i, method) {
	$[method] = $.dpost = function(url, data, success, dataType, error) {
		if (typeof data === 'function') {
			error = dataType;
			dataType = success;
			success = data;
			data = undefined;
		}
		if (typeof success === 'string') {
			error = dataType;
			dataType = success;
			success = undefined;
		}
		if (typeof dataType === 'function') {
			error = dataType;
			dataType = undefined;
		}

		if (typeof success !== 'function') {
			success = function (data) {
				if (data.error) {
					$.dalert(data.error);
					return;
				}
			};
		}
		if (typeof dataType !== 'string') {
			dataType = 'json';
		}
		if (typeof error !== 'function') {
			error = function (xhr) {
				console.log(xhr.responseText);
			};
		}

		$.ajax({
			url: url,
			type: method == 'dpost' ? 'POST' : 'GET',
			dataType: dataType,
			data: data,
			success: success,
			error: error
		});
	}
});

/* dformDcoreResult
 * --------------------------------------------------------------------- */
$.dcoreSubmitResult = function(data, noPjax) {
	function redirect() {
		if (data.redirect) {
			if (noPjax == true || (typeof data.noPjax != 'undefined' && data.noPjax == true)) {
				location.href = data.redirect;
			} else {
				$.pjaxRedirect(data.redirect);
			}
		}
	}
	if (data.error) {
		$.dtoast(data.error, null, true);
		return;
	} else if (data.message) {
		$.dalert(data.message, redirect);
		return;
	}
	redirect();
};

/* dcorePostResult
 * --------------------------------------------------------------------- */
$.dcorePostResult = function(form, noPjax, onSuccess) {
	var submit = form.find('button[type="submit"]');
	if (submit.dformIsLoading()) {
		return false;
	}
	submit.dformLoading();
	$.ajax({
		url: form.attr('action'),
		type: 'POST',
		timeout: 10000,
		dataType: 'json',
		data: form.serialize(),
		success: function (data, status, xhr) {
			submit.dformLoaded();
			if (typeof onSuccess == 'function') {
				onSuccess(data);
			} else {
				$.dcoreSubmitResult(data, noPjax);
			}
		},
		error: function (xhr, status, error) {
			submit.dformLoaded();
			$.dalert(xhr.responseText);
		}
	});
	return false;
};
$(document).bind('dofirst', function (e, t) {
	$(t).find('form.dcore-form').each(function () {
		var form = $(this);
		form.dform({
			submit: function () {
				return $.dcorePostResult(form);
			}
		});
	});
});

/* infinite scroll
 * ===================================================================== */
$(document).bind('doscroll', function () {
	var sctop = $(window).scrollTop();
	var winh = $(window).height();
	var bodyh = Math.round($('body').outerHeight());
	$('.dcore-pagination.infinite-.scroll-').each(function () {
		var me = $(this);
		var timeout = me.data('dcore-pagination-timeout');
		if (sctop + winh >= bodyh * 0.9) {
			if (timeout) {
				clearTimeout(timeout);
			}
			timeout = setTimeout(function () {
				me.trigger('load-next');
			}, 100);
			me.data('dcore-pagination-timeout', timeout);
		}
	});
});
$(document).bind('dofirst', function (e, t) {
	$(t).find('.dcore-pagination').bind('load-page', function (e, targetLi) {
		var me = $(this);
		var moreButton = me.parent().find('.dcore-infinite-more');
		if (me.hasClass('loading-')) {
			return;
		}
		var li = $(targetLi);
		if (li.length > 0) {
			var nextPageHref = li.find('a').attr('href');
			if (nextPageHref) {
				me.addClass('loading-');
				$('html').addClass('loading-next');
				setTimeout(function () {
					$('html').addClass('loading-next-end');
				}, 1);
				$.dget(nextPageHref, function (data) {
					var tmp = $('<div />').html(data);
					var newMe = tmp.find('.dcore-pagination');
					if (newMe.length > 0) {
						me.html(newMe.html());
						if (me.hasClass('replace-')) {
							me.trigger('setup-links');
						}
						if (moreButton.length > 0 &&
							me.children('li.active').length == 0 ||
							me.children('li.active').next().length == 0) {
							moreButton.remove();
						}
					}
					var itemsSelector = me.attr('data-items');
					var wrap = $(itemsSelector);
					if (wrap.length > 0) {
						if (me.hasClass('replace-')) {
							var items = tmp.find(itemsSelector + ' > *');
							items.appendTo(wrap.empty());
						} else {
							var items = tmp.find(itemsSelector + ' > *:not(.sticky)');
							items.appendTo(wrap);
						}
						if (wrap.hasClass('masonry')) {
							wrap.isotope('appended', items);
							wrap.isotope('layout');
						}
						items.dofirst();
						setTimeout(function () {
							me.removeClass('loading-');
							$('html').removeClass('loading-next-end');
							setTimeout(function () {
								$('html').removeClass('loading-next');
							}, 400);
						}, 1000);
						$(document).trigger('doresize');
						$.pjaxCacheUrl = location.href;
					}
				}, 'text');
			}
		}
	}).filter('.infinite-').bind('load-next', function () {
		var me = $(this);
		var currentLi = me.children('li.active');
		if (currentLi.length > 0) {
			me.trigger('load-page', currentLi.next());
		}
	}).each(function () {
		var me = $(this);
		var moreButton = me.parent().find('.dcore-infinite-more').removeClass('hide');
		var currentLi = me.children('li.active');
		if (currentLi.length > 0) {
			if (moreButton.length > 0) {
				moreButton.find('button').click(function (e) {
					e.preventDefault();
					e.stopPropagation();
					me.trigger('load-next');
				});
			}
		} else {
			if (moreButton.length > 0) {
				moreButton.remove();
			}
		}
	}).end().filter('.replace-').bind('setup-links', function () {
		var me = $(this);
		var lis = me.children('li');
		var as = lis.children('a');
		as.click(function (e) {
			e.preventDefault();
			e.stopPropagation();
			var a = $(this);
			var li = a.parent();
			me.trigger('load-page', li);
		});
	}).trigger('setup-links');
});

/* dquantity
 * ===================================================================== */
$.fn.dquantity = function () {
	return $(this).each(function () {
		var me = $(this);
		var input = me.find('input');
		var decrease = me.find('button.decrease-');
		var increase = me.find('button.increase-');

		function fixval() {
			input.val(input.val().replace(/[^0-9]/, ''));
			if (parseInt(input.val()) < 1) {
				input.val('1');
			}
		}

		input.focus(function () {
			input.blur();
		});

		input.change(function () {
			fixval();
		});

		decrease.click(function (e) {
			e.preventDefault();
			fixval();
			var val = parseInt(input.val()) - 1;
			if (val >= 1) {
				input.val(val).change();
			}
		});

		increase.click(function (e) {
			e.preventDefault();
			fixval();
			var val = parseInt(input.val()) + 1;
			input.val(val).change();
		});
	});
};
$(document).bind('dofirst', function (e, t) {
	$(t).find('.dcore-quantity').dquantity();
});

/* cart count
 * ===================================================================== */
$(document).bind('update-cart', function (e, show) {
	var targets = $('.dcore-cart-count-outer');
	$.dget('/api/cart/total/html', function (html) {
		var tmp = $('<div />').html(html);
		var newOuter = tmp.find('.dcore-cart-count-outer');
		if (newOuter.length > 0) {
			targets.each(function () {
				var me = $(this);
				var originalClasses = me.children('a').attr('class');
				me.html(newOuter.html());
				me.children('a').addClass(originalClasses);
				if (show) {
					me.addClass('active-').clickOutside(function () {
						me.removeClass('active-');
					});
				}
			});
		}
	}, 'html');
});
$(function () {
	$('.dcore-cart-count-outer').each(function () {
		var me = $(this);
		me.parent().mouseover(function () {
			me.removeClass('active-');
		});
		me.mouseover(function () {
			me.removeClass('active-');
		});
	});
});

/* dofirst
 * ===================================================================== */
$(document).bind('dofirst', function (e, t) {
	$(t).find('.dcore-actions').each(function () {
		var me = $(this);
		var button = me.find('.dropdown-button');
		if (me.find('.dropdown-content > li').length == 0) {
			me.remove();
		}
	});

	$(t).find('select.dcore-set, input.dcore-set, textarea.dcore-set')
	.bind('set-original-value', function () {
		$(this).data('original-value', $(this).val());
	}).each(function () {
		$(this).trigger('set-original-value');
	}).bind('restore-original-value', function () {
		var me = $(this);
		var originalValue = me.data('original-value');
		if (originalValue) {
			me.addClass('do-not-set-');
			if (me.get(0).tagName == 'SELECT') {
				var options = me.find('option');
				var selectedOption = options.filter('[value="' + originalValue + '"]');
				options.not(selectedOption.prop('selected', true)).prop('selected', false);
				if (me.parent().hasClass('select-wrapper')) {
					me.material_select();
				}
			} else {
				me.val(originalValue);
			}
			me.change().removeClass('do-not-set-').trigger('set-original-value');
		}
	}).change(function () {
		var me = $(this);
		if (me.hasClass('dform-error') || me.hasClass('do-not-set-')) {
			return;
		}
		var value = me.val();
		if (me.attr('data-confirm-' + value)) {
			$.dconfirm(me.attr('data-confirm-' + value), function () {
				set();
			}, function () {
				me.trigger('restore-original-value');
			});
		} else {
			set();
		}

		function set() {
			me.trigger('set-original-value');
			var params = {};
			params[me.attr('name')] = value;
			$.dpost(me.attr('data-url') + '/rules/validation_rules_' + me.attr('name'), params, function (data) {
				if (data.error) {
					$.dtoast(/*'<span class="fa fa-frown-o"></span>&nbsp;&nbsp;' + */data.error, null, true);
				} else if (data.message) {
					$.dtoast(/*'<span class="fa fa-smile-o"></span>&nbsp;&nbsp;' + */data.message, null, true);
				}
				$.dtoast(/*'<span class="fa fa-smile-o"></span>&nbsp;&nbsp;' + */'저장 되었습니다.', null, true);
			}, 'json');
		}
	});

	$(t).find('button.dcore-notify-order-status').each(function (e) {
		var me = $(this);
		if (me.attr('data-depend-on') && me.attr('data-enable-on')) {
			var depend = $(me.attr('data-depend-on'));
			var statuses = me.attr('data-enable-on').split(',');
			depend.bind('enable-me', function () {
				me.prop('disabled', $.inArray(depend.val(), statuses) < 0);
			}).change(function () {
				depend.trigger('enable-me');
			}).trigger('enable-me');
		}
	}).click(function (e) {
		e.preventDefault();
		var me = $(this);
		var url = me.attr('data-url');

		me.prop('disabled', true);
		$.dpost(me.attr('data-url'), function (data) {
			me.prop('disabled', false);
			if (data.error) {
				$.dtoast(/*'<span class="fa fa-frown-o"></span>&nbsp;&nbsp;' + */data.error, null, true);
			} else if (data.message) {
				$.dtoast(/*'<span class="fa fa-smile-o"></span>&nbsp;&nbsp;' + */data.message, null, true);
			}
		}, 'json');
	});

	/* dcore-expected-redirection */
	$(t).find('a.dcore-expected-redirection').click(function (e) {
		e.preventDefault();
		var a = $(this);
		var href = a.attr('href');
		var datas = href.split('?');
		$.dpost(datas.length > 1 ? datas[0] : href, datas.length > 1 ? datas[1] : '', function (data) {
			$.dcoreSubmitResult(data);
		}, 'json');
	});

	/* table */
	$(t).find('.dcore-body table').each(function () {
		$(this).addClass('bordered responsive-table-');
	});
	$(t).find('.dcore-body:not([contenteditable="true"]) table').each(function () {
		var table = $(this);
		table.wrap('<div class="overflow-x-outer" />');
		table.wrap('<div class="overflow-x" />');
	});

	/* search */
	$(t).find('form.dcore-search').submit(function () {
		var form = $(this);
		$.dpost(form.attr('action'), form.serialize(), function (data) {
			$.pjaxRedirect(data.redirect);
		}, 'json');
		return false;
	});

	/* tabs */
	$(t).find('.dcore-tabs').each(function () {
		var me = $(this);
		if (me.hasClass('installed-')) {
			return;
		}
		me.addClass('installed-');
		var tabs = me.find('.dcore-tab');
		var as = tabs.find('a');
		if (me.hasClass('auto-width-')) {
			tabs.css({ 'min-width': (100 / tabs.length) + '%' });
		}
		if (as.length > 0 && as.filter(':first').attr('href').match(/^#/)) {
			var contents = $(as.filter(':first').attr('href')).parent().children();
			as.click(function (e) {
				e.preventDefault();
				var a = $(this);
				var content = contents.filter(a.attr('href'));
				contents.not(content.removeClass('hide')).addClass('hide');
				as.not(a.addClass('active')).removeClass('active');
			});
			var activated = as.filter('.active');
			if (activated.length > 0) {
				activated.click();
			} else {
				as.filter(':first').click();
			}
		}
	});

	/* dcore-post-related */
	$(t).find('.dcore-post-related').each(function () {
		var me = $(this);
		var $items = me.find('.post-related-items');
		var baseurl = me.attr('data-baseurl');

		var keyword = me.find('.post-related-keyword');
		var ulResult = $('#' + keyword.attr('data-activates'));
		keyword.dropdown({
			constrainWidth: false,
			belowOrigin: true
		});

		var timeout = null;
		function getRowsByKeyword(str) {
			if (timeout) {
				clearTimeout(timeout);
			}
			timeout = setTimeout(function () {
				$.dget(baseurl + '/search', { keyword: str }, function (rows) {
					ulResult.empty();
					$(rows).each(function () {
						var row = this;
						if (me.attr('data-include-me') != 'true' && row.uid == me.attr('data-uid')) {
							return;
						}
						var li = $('<li />').appendTo(ulResult);
						var a = $('<a />').attr('href', '#post-' + row.uid).addClass('no-pjax').appendTo(li);
						if (row.featured_image) {
							$('<span />').addClass('right circle').css({
								display: 'block',
								width: 30,
								height: 30,
								marginTop: -3,
								marginLeft: 10,
								backgroundColor: '#ebebeb',
								backgroundRepeat: 'no-repeat',
								backgroundSize: 'cover',
								backgroundPosition: 'center top',
								backgroundImage: 'url(' + row.featured_image.furl + ')'
							}).appendTo(a);
						}
						$('<span />').html(row.title + (row.subtitle ? ' <small><em>' + row.subtitle + '&nbsp;</em></small>' : '')).appendTo(a);
						a.append('&nbsp;&nbsp;');
						$('<small />').text(row.price_sale).appendTo(a);
						a.append('&nbsp;&nbsp;');
						$('<small />').text(row.time).appendTo(a);
						a.click(function (e) {
							e.preventDefault();
							$.dpost(baseurl + '/create', {
								uid_post: row.uid
							}, function (data) {
								if (data.error) {
									$dtoast(data.error);
								} else if (data.uid) {
									addRow({
										uid: data.uid,
										post: row
									});
									keyword.dropdown('close');
									$items.trigger('update-order');
								}
							}, 'json');
						});
					});
					keyword.dropdown('open');
				}, 'json');
			}, 500);
		}

		keyword.focus(function () {
			if (ulResult.find('li').length == 0) {
				getRowsByKeyword(keyword.val());
			}
		}).keyup(function () {
			getRowsByKeyword(keyword.val());
		});

		$items.sortable({
			handle: '.card',
			items: '> .dsave-item',
			update: function() {
				$items.trigger('update-order');
			}
		}).bind('update-order', function() {
			var orders= $(this).sortable('serialize');
			$.dpost(baseurl + '/orders', orders, function(data) {
				if (data != '__OK__') {
					$.dtoast(data);
					return;
				}
			}, 'text');
		});

		function addRow(row) {
			var col = $('<div />').addClass('dsave-item col s12 m6').attr({
				id: 'item-' + row.uid
			}).appendTo($items);
			var card = $('<div />').addClass('card').appendTo(col);
			var cardContent = $('<div />').addClass('card-content').appendTo(card);
			card.css({
				cursor: 'move'
			});
			if (row.post && row.post.featured_image) {
				$('<div />').addClass('right circle').css({
					display: 'block',
					width: 30,
					height: 30,
					marginTop: -3,
					backgroundColor: '#ebebeb',
					backgroundRepeat: 'no-repeat',
					backgroundSize: 'cover',
					backgroundPosition: 'center top',
					backgroundImage: 'url(' + row.post.featured_image.furl + ')'
				}).appendTo(cardContent);
			}
			var span = $('<span />').css({
				display: 'inline-block',
				maxWidth: 'calc(100% - 80px)',
				overflow: 'hidden',
				textOverflow: 'ellipsis',
				whiteSpace: 'nowrap',
				verticalAlign: 'middle'
			}).html(row.post ? row.post.title + (row.post.subtitle ? '&nbsp;<small><em>' + row.post.subtitle + '&nbsp;</em><small>' : '') : '').appendTo(cardContent);
			span.append('&nbsp;&nbsp;');
			$('<small />').text(row.post ? row.post.price_sale : '').appendTo(span);
			span.append('&nbsp;&nbsp;');
			$('<small />').text(row.post ? row.post.time : '').appendTo(span);
			span.tooltip({
				content: span.text()
			});

			$('<button />').attr('type', 'button')
				.addClass('dsave-remove btn btn-floating waves-effect waves-light')
				.html('<span class="fa fa-times"></span>')
				.appendTo(card)
				.click(function (e) {
					e.preventDefault();
				//	$.dconfirm(me.attr('data-delete-message'), function () {
						$.dpost(baseurl + '/' + row.uid + '/delete');
						col.remove();
				//	});
				});
		}

		function load() {
			$.dget(baseurl, function (data) {
				$(data.rows).each(function () {
					addRow(this);
				});
			}, 'json');
		}

		load();
	});

	/* wish list */
	$(t).find('.dcore-add-to-wishlist').click(function (e) {
		e.preventDefault();
		var me = $(this);
		var baseurl = '/api/wishlist/';
		var uid = me.attr('data-uid');
		var uidProduct = me.attr('data-uid-product');
		if (uidProduct) {
			$.dpost(baseurl + (me.hasClass('active-') ? uid + '/delete' : 'create'), {
				uid_product: me.attr('data-uid-product')
			}, function (data) {
				if (data.redirect) {
					if (me.hasClass('active-')) {
						me.removeClass('active-');
					} else {
						uid = data.redirect.replace(new RegExp('^' + baseurl), '');
						me.addClass('active-').attr('data-uid', uid);
					}
				}
			}, 'json');
		}
	});

	/* cart */
	$(t).find('.dcore-cart').each(function () {
		var me = $(this);
		var baseUrl = me.hasClass('wishlist-') ? '/api/wishlist' : '/api/cart';
		var $list = me.find('.dcore-cart-list');
		var $summary = me.find('.dcore-cart-summary');
		var $noEntry = me.find('.dcore-cart-no-entry');
		var $template = me.find('.template-item').html();
		var $checkout = me.find('.dcore-cart-checkout');
		var $empty = me.find('.dcore-empty-cart');
		var rtdp = parseInt(me.attr('data-shop-currency-rtdp'));

		var loading = $('<div />').addClass('loading').appendTo(me).hide();
		$('<div />').addClass('spin').appendTo(loading).spin();
		$('<div />').addClass('screen').appendTo(loading);
		function viewLoading() { loading.stop().fadeIn(); }
		function hideLoading() { loading.stop().fadeOut(); }

		$checkout.click(function (e) {
			if ($list.find('.item.out-of-stock').length > 0) {
				e.preventDefault();
				e.stopPropagation();
				$.dalert(me.attr('data-out-of-stock'));
			}
		});

		$empty.click(function (e) {
			e.preventDefault();
			e.stopPropagation();
			$.dpost(baseUrl + '/empty', function (data) {
				$list.addClass('hide');
				$summary.addClass('hide');
				$noEntry.removeClass('hide');
				updateTotal();
			}, 'text');
		});

		function updateTotal() {
			$(document).trigger('update-cart');
			$.dget(baseUrl + '/total', function (total) {
				$('.dcore-cart-count')
					.attr('class', 'dcore-cart-count dcore-cart-count-' + total.count)
					.text(total.count);
				$('.dcore-cart-total-price').text(total.price).dformCurrency({ roundToDecimalPlace: rtdp });
				$('.dcore-cart-shipping-cost').text(total.shipping_cost).dformCurrency({ roundToDecimalPlace: rtdp });
				$('.dcore-cart-amount-to-pay').text(parseFloat(total.price) + parseFloat(total.shipping_cost)).dformCurrency({ roundToDecimalPlace: rtdp });
			}, 'json');
		}

		function drawRows(rows) {
			$list.empty();
			$(rows).each(function () {
				var row = this;
				var $item = $('<div />').addClass('item').html($template).appendTo($list);
				var $image = $item.find('.data-image');
				var $link = $item.find('.data-link');
				var $title = $item.find('.data-title');
				var $subtitle = $item.find('.data-subtitle');
				var $itemOptions = $item.find('.item-options');
				var $options = $item.find('.data-options');
				var $price = $item.find('.data-price');
				var $wrapCost = $item.find('.data-gift-wrap-cost');
				var $quantity = $item.find('.data-quantity');
				var $total = $item.find('.data-total');
				var $addToCart = $item.find('.add-to-cart');
				var $remover = $item.find('.remover');

				if (row.in_stock) {
					$item.removeClass('out-of-stock');
				} else {
					$item.addClass('out-of-stock');
				}
				$link.attr('href', row.base_url + '/' + row.slug);
				if (row.featured_image) {
					var f = row.featured_image;
					$image.find('.data-link').append('<img src="' + row.base_url + '/download/'+f.uid+'/w/300/'+encodeURIComponent(f.fname).replace(/[!'()*]/g, escape)+'" alt="" />');
				}
				$title.html(row.product_title);
				$subtitle.html(row.product_subtitle);
				if (row.options) {
					$options.html(row.options);
					$itemOptions.removeClass('hide');
				}
				$price.text(row.price).dformCurrency({ roundToDecimalPlace: rtdp });
				if ($wrapCost.length > 0) {
					if (row.gift_wrap == 'Y') {
						$wrapCost.html(row.gift_wrap_cost).dformCurrency({ roundToDecimalPlace: rtdp });
					} else {
						$wrapCost.parents('.item-gift-wrap').remove();
					}
				}
				$total.text(
					(
						parseFloat(row.price) + parseFloat(
							row.gift_wrap == 'Y' ? row.gift_wrap_cost : 0
						)
					) * row.quantity
				).dformCurrency({ roundToDecimalPlace: rtdp });

				var d = $('<div class="dcore-quantity"></div>').appendTo($quantity);
				var quantity = $('<input type="text" readonly />').addClass('no-border-').val(row.quantity).appendTo(d);
				$('<button type="button" />').text('-').addClass('decrease-').appendTo(d);
				$('<button type="button" />').text('+').addClass('increase-').appendTo(d);
				d.dquantity();
				quantity.change(function () {
					viewLoading();
					$.dpost(baseUrl + '/create', {
						product_title: row.product_title,
						product_subtitle: row.product_subtitle,
						uid_product: row.uid_product,
						uid_variation: row.uid_variation,
						replaceQuantity: 'true',
						quantity: quantity.val()
					}, function (data) {
						hideLoading();
						if (data.error) {
							$.dtoast(data.error);
						}
						$.dget(row.url_view, function (o) {
							quantity.val(o.row.quantity);
							$total.text(o.row.quantity * o.row.price).dformCurrency({ roundToDecimalPlace: rtdp });
							updateTotal();
							if (!data.error && $item.hasClass('out-of-stock')) {
								$item.removeClass('out-of-stock');
							}
						}, 'json');
					}, 'json');
				});

				$addToCart.click(function (e) {
					e.preventDefault();
					viewLoading();
					$.dpost(baseUrl + '/' + row.uid + '/addtocart', function (data) {
						hideLoading();
						$(document).trigger('update-cart', true);
						if ($list.children('.item').length > 1) {
							$item.remove();
						} else {
							procData(null);
						}
					}, 'text');
				});

				$remover.click(function (e) {
					e.preventDefault();
					e.stopPropagation();
					viewLoading();
					$.dpost(baseUrl + '/' + row.uid + '/delete', function (data) {
						hideLoading();
						if ($list.children('.item').length > 1) {
							$item.remove();
						} else {
							procData(null);
						}
						updateTotal();
					}, 'json');
				});
			});
		}

		function procData(data) {
			if (data && data.rows && data.rows.length > 0) {
				drawRows(data.rows);
				updateTotal();
				$list.removeClass('hide');
				$summary.removeClass('hide');
				$noEntry.addClass('hide');
			} else {
				$list.addClass('hide');
				$summary.addClass('hide');
				$noEntry.removeClass('hide');
			}
		}

		function getRows() {
			viewLoading();
			$.dget(baseUrl, function (data) {
				hideLoading();
				procData(data);
			}, 'json');
		}

		getRows();
	});

	/* popup window */
	$(t).find('a[data-popup-width][data-popup-height]').click(function (e) {
		e.preventDefault();
		e.stopPropagation();
		var a = $(this);
		var href = a.attr('href');
		var w = a.attr('data-popup-width');
		var h = a.attr('data-popup-height');
		window.open(href, '_blank', 'width=' + w + ', height=' + h);
	});

	/* share post */
	$(t).find('.dcore-share-post a').click(function (e) {
		var a = $(this);
		var href = a.attr('href');
		if (a.hasClass('clipboard')) {
			e.preventDefault();
			var tmp = $('<div />').addClass('hide').appendTo('body');
			var button = $('<button />').attr('data-clipboard-text', href).appendTo(tmp);
			new Clipboard('button[data-clipboard-text]');
			button.click();
			tmp.remove();
			$.dtoast('링크를 클립보드에 복사했습니다.');
			return;
		} else if (a.hasClass('kakaotalk')) {
			e.preventDefault();
			return;
		} else if (a.hasClass('line')) {
		//	return true;
		} else if (a.hasClass('pinterest')) {
			e.preventDefault();
			$('[data-pin-href]').click();
			return;
		}
		e.preventDefault();
		window.open(href, '_blank', 'width=626, height=436');
	}).filter('.clipboard').each(function () {
		if (!$.isClipboardJsScriptLoaded) {
			(function() {
				var e = document.createElement('script');
				e.type = 'text/javascript';
				e.async = true;
				e.src = '//cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.10/clipboard.min.js';
				var s = document.getElementsByTagName('script')[0];
				s.parentNode.insertBefore(e, s);
				$.isClipboardJsScriptLoaded = true;
			})();
		}
	}).end().filter('.pinterest').each(function () {
		$('script[id^="PIN_"]').remove();
		$('[data-pin-do]').remove();
		$('<a href="https://www.pinterest.com/pin/create/button/" data-pin-do="buttonBookmark" class="hide"></a>').appendTo('.hiddendiv');
		(function() {
			var e = document.createElement('script');
			e.type = 'text/javascript';
			e.async = true;
			e.src = '//assets.pinterest.com/js/pinit.js';
			var s = document.getElementsByTagName('script')[0];
			s.parentNode.insertBefore(e, s);
		})();
	}).end().filter('.kakaotalk').each(function () {
		var me = $(this);
		var appkey = me.attr('data-appkey');
		if (typeof Kakao == 'undefined') {
			(function() {
				var e = document.createElement('script');
				e.type = 'text/javascript';
				e.async = true;
				e.src = 'https://developers.kakao.com/sdk/js/kakao.min.js';
				var s = document.getElementsByTagName('script')[0];
				s.parentNode.insertBefore(e, s);
				s.onload = function () {
					setTimeout(function () {
						Kakao.init(appkey);
						createKakaoButton();
					}, 100);
				};
			})();
		} else {
			createKakaoButton();
		}
		function createKakaoButton() {
			Kakao.Link.createTalkLinkButton({
				container: me.get(0),
				label: me.attr('data-title'),
				image: {
					src: me.attr('data-image'),
					width: me.attr('data-image-width'),
					height: me.attr('data-image-height')
				},
				webButton: {
					text: '방문하기',
					url: me.attr('data-href')
				}
			});
		}
	});

	/* instagram feed */
	$(t).find('.dcore-instagram-feed').each(function () {
		// http://instagram.pixelunion.net/
		var me = $(this);
		var token = me.attr('data-token');
		if (!token) {
			return;
		}
		var count = me.attr('data-count') ? me.attr('data-count') : 3;
		var url = 'https://api.instagram.com/v1/' + (
			me.attr('data-tag') ?
				'tags/' + me.attr('data-tag') + '/media/recent' :
				'users/self/media/recent'
		);
		$.dget(url + '/?count=' + count + '&access_token=' + token , function (res) {
			if (res && res.data) {
				var ul = $('<ul />').appendTo(me);
				$(res.data).each(function () {
					var data = this;
					var li = $('<li />').appendTo(ul);
					var a = $('<a />').attr({
						href: data.link,
						target: '_blank'
					}).addClass('dcore-zoom-in-').appendTo(li);
					var image = $('<span />').addClass('image').appendTo(a);
					var cover = $('<span />').addClass('dcore-zoom-cover').css({
						backgroundImage: 'url(' + data.images.standard_resolution.url + ')'
					}).appendTo(image);
					var likes = $('<span />').addClass('texts').appendTo(a);
					$('<span />').addClass('fa fa-heart').appendTo(likes);
					likes.append(' ' + data.likes.count);
				});
			}
		}, 'json');
	});

	/* kakao login */
	$(t).find('.dcore-kakao-login').click(function () {
		var me = $(this);
		var form = me.parents('form');
		var redir = form.find('[name="redir"]');
		var appkey = me.attr('data-appkey');
		Kakao.cleanup();
		Kakao.init(appkey);
		Kakao.Auth.login({
			success: function (obj) {
				$.dpost('/user/loginwithkakao', obj, function (data) {
					if (data == '__OK__') {
						/* DO NOT USE PJAX */
						if (form.data('url')) {
							location.href = form.data('url');
						} else if (redir.val() != '') {
							location.href = redir.val();
						} else {
							location.reload();
						}
					} else if (data == '__SIGNUP__') {
						$.pjaxRedirect('/user/signup/kakao');
					} else {
						console.log(data);
						$.dalert('로그인을 할 수 없습니다.');
					}
				}, 'text');
			},
			fail: function (err) {
				$.dalert('로그인을 할 수 없습니다.');
			}
		});
	});
});

$(document).bind('dofirst', function (e, t) {
	$(t).find('.dcore-popups').each(function () {
		var me = $(this);
		var items = me.find('.item');
		if (items.length == 0) {
			return;
		}
		$.dmodal({
			callback: function (c) {
				me.appendTo(c).removeClass('hide');
				items.each(function () {
					var item = $(this);
					var closer = item.find('.closer').click(function (e) {
						e.preventDefault();
						item.remove();
						if (me.find('.item').length == 0) {
							c.trigger('dmodal-close');
						}
					});
					item.find('.close-today').click(function (e) {
						e.preventDefault();
						var cookiename = 'dpopup' + item.attr('data-uid');
						$.cookie(cookiename, 'hide', { expires: 1 });
						closer.click();
					});
					item.find('*').click(function (e) {
						e.stopPropagation();
					});
				});
				me.click(function (e) {
					c.trigger('dmodal-close');
				});
				return me;
			}
		});
	});
});

$(document).bind('dofirst', function (e, t) {
	var board = null;
	var boardIndex = 0;
	var boards = [];

	$(t).find('.dcore-ajax-board').each(function () {
		var me = $(this);
		me.bind('ajax-board-init', function (e, callback) {
			if (me.hasClass('loading-')) {
				callback();
				return;
			}
			me.addClass('loading-');
			var baseUrl = me.attr('data-base-url');
			var uidProduct = me.attr('data-uid-product');
			$('html').addClass('loading-next');
			setTimeout(function () {
				$('html').addClass('loading-next-end');
			}, 1);
			$.dget(baseUrl + (uidProduct ? '/product/' + uidProduct : ''), function (data) {
				setTimeout(function () {
					me.removeClass('loading-');
					$('html').removeClass('loading-next-end');
					setTimeout(function () {
						$('html').removeClass('loading-next');
					}, 400);
				}, 1);
				var tmp = $('<div />').html(data);
				me.html(tmp.find('.dcore-list')).dofirst();
				me.find('.board-view-product').remove();
				callback();
			}, 'text');
		});

		if (me.attr('data-auto-init') == 'true') {
			boards.push(me);
		}
	});

	if (boards.length > 0) {
		function initBoard() {
			board = boards[boardIndex++];
			if (board) {
				board.trigger('ajax-board-init', initBoard);
			}
		}
		initBoard();
	}

	$(t).find('.dcore-list .item.view-on-list-').each(function () {
		var me = $(this);
		var dcoreList = me.closest('.dcore-list');
		var link = me.find('> a.link:not(.private-alert)');
		var links = dcoreList.find('.item.view-on-list- > a.link').not(link);
		var view = me.find('> .item-view').hide().removeClass('hide');
		var views = dcoreList.find('.item.view-on-list- > .item-view').not(view);
		if (view.length > 0) {
			link.click(function (e) {
				e.preventDefault();
				e.stopPropagation();
				if (!view.is(':visible')) {
					link.addClass('current-');
					links.removeClass('current-');
					view.find('.list-button').remove();
					view.slideDown();
					views.slideUp();
				} else {
					link.removeClass('current-');
					view.slideUp();
				}
			});
		}
	});

	$(t).find('a.dcore-a-list').each(function () {
		var a = $(this);
		a.click(function (e) {
			if (history.length > 2 && !a.hasClass('cancel-history-')) {
				history.back();
				return false;
			}
		});
	});

	$(t).find('.dcore-checkout-billing-data [name="bill_ex"]').on('keyup', function (e) {
		var me = $(this);
		var val = me.val();
		if (
			val.length == 2 && (
				e.which != 8 &&
				e.which != 46
			)
		) {
			me.val(val + ' / ');
		}
	});
});
